"use strict";
const cxapi = require("@aws-cdk/cx-api");
const nodeunit_1 = require("nodeunit");
const lib_1 = require("../../lib");
const stacks_1 = require("../../lib/api/cxapp/stacks");
const settings_1 = require("../../lib/settings");
const util_1 = require("../util");
function testStacks({ env, versionReporting = true } = {}) {
    const configuration = new settings_1.Configuration();
    configuration.settings.set(['versionReporting'], versionReporting);
    return new stacks_1.AppStacks({
        configuration,
        aws: new lib_1.SDK(),
        synthesizer: async () => util_1.testAssembly({
            stackName: 'withouterrors',
            env,
            template: { resource: 'noerrorresource' },
        }, {
            stackName: 'witherrors',
            env,
            template: { resource: 'errorresource' },
            metadata: {
                '/resource': [
                    {
                        type: cxapi.ERROR_METADATA_KEY,
                        data: 'this is an error'
                    }
                ]
            },
        }),
    });
}
module.exports = nodeunit_1.testCase({
    async 'do not throw when selecting stack without errors'(test) {
        // GIVEN
        const stacks = testStacks();
        // WHEN
        const selected = await stacks.selectStacks(['withouterrors'], {
            defaultBehavior: stacks_1.DefaultSelection.AllStacks
        });
        stacks.processMetadata(selected);
        // THEN
        test.equal(selected[0].template.resource, 'noerrorresource');
        test.done();
    },
    async 'do throw when selecting stack with errors'(test) {
        // GIVEN
        const stacks = testStacks();
        // WHEN
        try {
            const selected = await stacks.selectStacks(['witherrors'], {
                defaultBehavior: stacks_1.DefaultSelection.AllStacks
            });
            stacks.processMetadata(selected);
            test.ok(false, 'Did not get exception');
        }
        catch (e) {
            test.ok(/Found errors/.test(e.toString()), 'Wrong error');
        }
        test.done();
    },
    async 'select behavior: all'(test) {
        // GIVEN
        const stacks = testStacks();
        // WHEN
        const x = await stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.AllStacks });
        // THEN
        test.deepEqual(x.length, 2);
        test.done();
    },
    async 'select behavior: none'(test) {
        // GIVEN
        const stacks = testStacks();
        // WHEN
        const x = await stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.None });
        // THEN
        test.deepEqual(x.length, 0);
        test.done();
    },
    async 'select behavior: single'(test) {
        // GIVEN
        const stacks = testStacks();
        // WHEN
        let thrown;
        try {
            await stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.OnlySingle });
        }
        catch (e) {
            thrown = e.message;
        }
        // THEN
        test.ok(thrown && thrown.includes('Since this app includes more than a single stack, specify which stacks to use (wildcards are supported)'));
        test.done();
    },
    'AWS::CDK::Metadata': {
        async 'is generated for relocatable stacks'(test) {
            const stacks = testStacks({ env: `aws://${cxapi.UNKNOWN_ACCOUNT}/${cxapi.UNKNOWN_REGION}`, versionReporting: true });
            const result = await stacks.synthesizeStack('withouterrors');
            const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
            test.deepEqual(metadata, {
                Type: 'AWS::CDK::Metadata',
                Properties: {
                    Modules: `${require('../../package.json').name}=${require('../../package.json').version}`
                }
            });
            test.done();
        },
        async 'is generated for stacks in supported regions'(test) {
            const stacks = testStacks({ env: 'aws://012345678912/us-east-1', versionReporting: true });
            const result = await stacks.synthesizeStack('withouterrors');
            const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
            test.deepEqual(metadata, {
                Type: 'AWS::CDK::Metadata',
                Properties: {
                    Modules: `${require('../../package.json').name}=${require('../../package.json').version}`
                }
            });
            test.done();
        },
        async 'is not generated for stacks in unsupported regions'(test) {
            const stacks = testStacks({ env: 'aws://012345678912/bermuda-triangle-1337', versionReporting: true });
            const result = await stacks.synthesizeStack('withouterrors');
            const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
            test.equal(metadata, undefined);
            test.done();
        }
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5zdGFja3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LnN0YWNrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEseUNBQTBDO0FBQzFDLHVDQUEwQztBQUMxQyxtQ0FBZ0M7QUFDaEMsdURBQXlFO0FBQ3pFLGlEQUFtRDtBQUNuRCxrQ0FBdUM7QUEwSHZDLFNBQVMsVUFBVSxDQUFDLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixHQUFHLElBQUksS0FBbUQsRUFBRTtJQUNyRyxNQUFNLGFBQWEsR0FBRyxJQUFJLHdCQUFhLEVBQUUsQ0FBQztJQUMxQyxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUVuRSxPQUFPLElBQUksa0JBQVMsQ0FBQztRQUNuQixhQUFhO1FBQ2IsR0FBRyxFQUFFLElBQUksU0FBRyxFQUFFO1FBQ2QsV0FBVyxFQUFFLEtBQUssSUFBSSxFQUFFLENBQUMsbUJBQVksQ0FBQztZQUNwQyxTQUFTLEVBQUUsZUFBZTtZQUMxQixHQUFHO1lBQ0gsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFO1NBQzFDLEVBQ0Q7WUFDRSxTQUFTLEVBQUUsWUFBWTtZQUN2QixHQUFHO1lBQ0gsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRTtZQUN2QyxRQUFRLEVBQUU7Z0JBQ1IsV0FBVyxFQUFFO29CQUNYO3dCQUNFLElBQUksRUFBRSxLQUFLLENBQUMsa0JBQWtCO3dCQUM5QixJQUFJLEVBQUUsa0JBQWtCO3FCQUN6QjtpQkFDRjthQUNGO1NBQ0YsQ0FBQztLQUNILENBQUMsQ0FBQztBQUNMLENBQUM7QUFsSkQsaUJBQVMsbUJBQVEsQ0FBQztJQUNoQixLQUFLLENBQUMsa0RBQWtELENBQUMsSUFBVTtRQUNqRSxRQUFRO1FBQ1IsTUFBTSxNQUFNLEdBQUcsVUFBVSxFQUFFLENBQUM7UUFFNUIsT0FBTztRQUNQ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QUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLE9BQU8sRUFBRTtpQkFDMUY7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxDQUFDO1FBRUQsS0FBSyxDQUFDLG9EQUFvRCxDQUFDLElBQVU7WUFDbkUsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLEVBQUUsR0FBRyxFQUFFLDBDQUEwQyxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFFdkcsTUFBTSxNQUFNLEdBQUcsTUFBTSxNQUFNLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzdELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUNwRixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUVoQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxDQUFDO0tBQ0Y7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3hhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9jeC1hcGknKTtcbmltcG9ydCB7IFRlc3QsIHRlc3RDYXNlIH0gZnJvbSAnbm9kZXVuaXQnO1xuaW1wb3J0IHsgU0RLIH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IEFwcFN0YWNrcywgRGVmYXVsdFNlbGVjdGlvbiB9IGZyb20gJy4uLy4uL2xpYi9hcGkvY3hhcHAvc3RhY2tzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9saWIvc2V0dGluZ3MnO1xuaW1wb3J0IHsgdGVzdEFzc2VtYmx5IH0gZnJvbSAnLi4vdXRpbCc7XG5cbmV4cG9ydCA9IHRlc3RDYXNlKHtcbiAgYXN5bmMgJ2RvIG5vdCB0aHJvdyB3aGVuIHNlbGVjdGluZyBzdGFjayB3aXRob3V0IGVycm9ycycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHNlbGVjdGVkID0gYXdhaXQgc3RhY2tzLnNlbGVjdFN0YWNrcyhbJ3dpdGhvdXRlcnJvcnMnXSwge1xuICAgICAgZGVmYXVsdEJlaGF2aW9yOiBEZWZhdWx0U2VsZWN0aW9uLkFsbFN0YWNrc1xuICAgIH0pO1xuICAgIHN0YWNrcy5wcm9jZXNzTWV0YWRhdGEoc2VsZWN0ZWQpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoc2VsZWN0ZWRbMF0udGVtcGxhdGUucmVzb3VyY2UsICdub2Vycm9ycmVzb3VyY2UnKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdkbyB0aHJvdyB3aGVuIHNlbGVjdGluZyBzdGFjayB3aXRoIGVycm9ycycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcygpO1xuXG4gICAgLy8gV0hFTlxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZWxlY3RlZCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWyd3aXRoZXJyb3JzJ10sIHtcbiAgICAgICAgZGVmYXVsdEJlaGF2aW9yOiBEZWZhdWx0U2VsZWN0aW9uLkFsbFN0YWNrc1xuICAgICAgfSk7XG4gICAgICBzdGFja3MucHJvY2Vzc01ldGFkYXRhKHNlbGVjdGVkKTtcblxuICAgICAgdGVzdC5vayhmYWxzZSwgJ0RpZCBub3QgZ2V0IGV4Y2VwdGlvbicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRlc3Qub2soL0ZvdW5kIGVycm9ycy8udGVzdChlLnRvU3RyaW5nKCkpLCAnV3JvbmcgZXJyb3InKTtcbiAgICB9XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnc2VsZWN0IGJlaGF2aW9yOiBhbGwnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrcyA9IHRlc3RTdGFja3MoKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB4ID0gYXdhaXQgc3RhY2tzLnNlbGVjdFN0YWNrcyhbXSwgeyBkZWZhdWx0QmVoYXZpb3I6IERlZmF1bHRTZWxlY3Rpb24uQWxsU3RhY2tzIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZGVlcEVxdWFsKHgubGVuZ3RoLCAyKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnc2VsZWN0IGJlaGF2aW9yOiBub25lJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFja3MgPSB0ZXN0U3RhY2tzKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgeCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoW10sIHsgZGVmYXVsdEJlaGF2aW9yOiBEZWZhdWx0U2VsZWN0aW9uLk5vbmUgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5kZWVwRXF1YWwoeC5sZW5ndGgsIDApO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdzZWxlY3QgYmVoYXZpb3I6IHNpbmdsZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGxldCB0aHJvd246IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgc3RhY2tzLnNlbGVjdFN0YWNrcyhbXSwgeyBkZWZhdWx0QmVoYXZpb3I6IERlZmF1bHRTZWxlY3Rpb24uT25seVNpbmdsZSB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvd24gPSBlLm1lc3NhZ2U7XG4gICAgfVxuXG4gICAgLy8gVEhFTlxuICAgIHRlc3Qub2sodGhyb3duICYmIHRocm93bi5pbmNsdWRlcygnU2luY2UgdGhpcyBhcHAgaW5jbHVkZXMgbW9yZSB0aGFuIGEgc2luZ2xlIHN0YWNrLCBzcGVjaWZ5IHdoaWNoIHN0YWNrcyB0byB1c2UgKHdpbGRjYXJkcyBhcmUgc3VwcG9ydGVkKScpKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnQVdTOjpDREs6Ok1ldGFkYXRhJzoge1xuICAgIGFzeW5jICdpcyBnZW5lcmF0ZWQgZm9yIHJlbG9jYXRhYmxlIHN0YWNrcycodGVzdDogVGVzdCkge1xuICAgICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcyh7IGVudjogYGF3czovLyR7Y3hhcGkuVU5LTk9XTl9BQ0NPVU5UfS8ke2N4YXBpLlVOS05PV05fUkVHSU9OfWAsIHZlcnNpb25SZXBvcnRpbmc6IHRydWUgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0YWNrcy5zeW50aGVzaXplU3RhY2soJ3dpdGhvdXRlcnJvcnMnKTtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gcmVzdWx0LnRlbXBsYXRlLlJlc291cmNlcyAmJiByZXN1bHQudGVtcGxhdGUuUmVzb3VyY2VzLkNES01ldGFkYXRhO1xuICAgICAgdGVzdC5kZWVwRXF1YWwobWV0YWRhdGEsIHtcbiAgICAgICAgVHlwZTogJ0FXUzo6Q0RLOjpNZXRhZGF0YScsXG4gICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICBNb2R1bGVzOiBgJHtyZXF1aXJlKCcuLi8uLi9wYWNrYWdlLmpzb24nKS5uYW1lfT0ke3JlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpLnZlcnNpb259YFxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGVzdC5kb25lKCk7XG4gICAgfSxcblxuICAgIGFzeW5jICdpcyBnZW5lcmF0ZWQgZm9yIHN0YWNrcyBpbiBzdXBwb3J0ZWQgcmVnaW9ucycodGVzdDogVGVzdCkge1xuICAgICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcyh7IGVudjogJ2F3czovLzAxMjM0NTY3ODkxMi91cy1lYXN0LTEnLCB2ZXJzaW9uUmVwb3J0aW5nOiB0cnVlIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdGFja3Muc3ludGhlc2l6ZVN0YWNrKCd3aXRob3V0ZXJyb3JzJyk7XG4gICAgICBjb25zdCBtZXRhZGF0YSA9IHJlc3VsdC50ZW1wbGF0ZS5SZXNvdXJjZXMgJiYgcmVzdWx0LnRlbXBsYXRlLlJlc291cmNlcy5DREtNZXRhZGF0YTtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKG1ldGFkYXRhLCB7XG4gICAgICAgIFR5cGU6ICdBV1M6OkNESzo6TWV0YWRhdGEnLFxuICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgTW9kdWxlczogYCR7cmVxdWlyZSgnLi4vLi4vcGFja2FnZS5qc29uJykubmFtZX09JHtyZXF1aXJlKCcuLi8uLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9ufWBcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH0sXG5cbiAgICBhc3luYyAnaXMgbm90IGdlbmVyYXRlZCBmb3Igc3RhY2tzIGluIHVuc3VwcG9ydGVkIHJlZ2lvbnMnKHRlc3Q6IFRlc3QpIHtcbiAgICAgIGNvbnN0IHN0YWNrcyA9IHRlc3RTdGFja3MoeyBlbnY6ICdhd3M6Ly8wMTIzNDU2Nzg5MTIvYmVybXVkYS10cmlhbmdsZS0xMzM3JywgdmVyc2lvblJlcG9ydGluZzogdHJ1ZSB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3RhY2tzLnN5bnRoZXNpemVTdGFjaygnd2l0aG91dGVycm9ycycpO1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSByZXN1bHQudGVtcGxhdGUuUmVzb3VyY2VzICYmIHJlc3VsdC50ZW1wbGF0ZS5SZXNvdXJjZXMuQ0RLTWV0YWRhdGE7XG4gICAgICB0ZXN0LmVxdWFsKG1ldGFkYXRhLCB1bmRlZmluZWQpO1xuXG4gICAgICB0ZXN0LmRvbmUoKTtcbiAgICB9XG4gIH0sXG59KTtcblxuZnVuY3Rpb24gdGVzdFN0YWNrcyh7IGVudiwgdmVyc2lvblJlcG9ydGluZyA9IHRydWUgfTogeyBlbnY/OiBzdHJpbmcsIHZlcnNpb25SZXBvcnRpbmc/OiBib29sZWFuIH0gPSB7fSkge1xuICBjb25zdCBjb25maWd1cmF0aW9uID0gbmV3IENvbmZpZ3VyYXRpb24oKTtcbiAgY29uZmlndXJhdGlvbi5zZXR0aW5ncy5zZXQoWyd2ZXJzaW9uUmVwb3J0aW5nJ10sIHZlcnNpb25SZXBvcnRpbmcpO1xuXG4gIHJldHVybiBuZXcgQXBwU3RhY2tzKHtcbiAgICBjb25maWd1cmF0aW9uLFxuICAgIGF3czogbmV3IFNESygpLFxuICAgIHN5bnRoZXNpemVyOiBhc3luYyAoKSA9PiB0ZXN0QXNzZW1ibHkoe1xuICAgICAgc3RhY2tOYW1lOiAnd2l0aG91dGVycm9ycycsXG4gICAgICBlbnYsXG4gICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ25vZXJyb3JyZXNvdXJjZScgfSxcbiAgICB9LFxuICAgIHtcbiAgICAgIHN0YWNrTmFtZTogJ3dpdGhlcnJvcnMnLFxuICAgICAgZW52LFxuICAgICAgdGVtcGxhdGU6IHsgcmVzb3VyY2U6ICdlcnJvcnJlc291cmNlJyB9LFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgJy9yZXNvdXJjZSc6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiBjeGFwaS5FUlJPUl9NRVRBREFUQV9LRVksXG4gICAgICAgICAgICBkYXRhOiAndGhpcyBpcyBhbiBlcnJvcidcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgIH0sXG4gICAgfSksXG4gIH0pO1xufVxuIl19