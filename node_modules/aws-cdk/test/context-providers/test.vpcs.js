"use strict";
const aws = require("aws-sdk");
const AWS = require("aws-sdk-mock");
const nodeunit = require("nodeunit");
const vpcs_1 = require("../../lib/context-providers/vpcs");
AWS.setSDKInstance(aws);
const mockSDK = {
    defaultAccount: () => Promise.resolve('123456789012'),
    defaultRegion: () => Promise.resolve('bermuda-triangle-1337'),
    cloudFormation: () => { throw new Error('Not Mocked'); },
    ec2: () => Promise.resolve(new aws.EC2()),
    ecr: () => { throw new Error('Not Mocked'); },
    route53: () => { throw new Error('Not Mocked'); },
    s3: () => { throw new Error('Not Mocked'); },
    ssm: () => { throw new Error('Not Mocked'); },
};
module.exports = nodeunit.testCase({
    async 'looks up the requested VPC'(test) {
        // GIVEN
        const filter = { foo: 'bar' };
        const provider = new vpcs_1.VpcNetworkContextProviderPlugin(mockSDK);
        AWS.mock('EC2', 'describeVpcs', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'foo', Values: ['bar'] }]);
            return cb(null, { Vpcs: [{ VpcId: 'vpc-1234567' }] });
        });
        AWS.mock('EC2', 'describeSubnets', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'vpc-id', Values: ['vpc-1234567'] }]);
            return cb(null, {
                Subnets: [
                    { SubnetId: 'sub-123456', AvailabilityZone: 'bermuda-triangle-1337', MapPublicIpOnLaunch: true },
                    { SubnetId: 'sub-789012', AvailabilityZone: 'bermuda-triangle-1337', MapPublicIpOnLaunch: false }
                ]
            });
        });
        AWS.mock('EC2', 'describeRouteTables', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'vpc-id', Values: ['vpc-1234567'] }]);
            return cb(null, {
                RouteTables: [
                    { Associations: [{ SubnetId: 'sub-123456' }], RouteTableId: 'rtb-123456', },
                    { Associations: [{ SubnetId: 'sub-789012' }], RouteTableId: 'rtb-789012', }
                ]
            });
        });
        AWS.mock('EC2', 'describeVpnGateways', (params, cb) => {
            test.deepEqual(params.Filters, [
                { Name: 'attachment.vpc-id', Values: ['vpc-1234567'] },
                { Name: 'attachment.state', Values: ['attached'] },
                { Name: 'state', Values: ['available'] }
            ]);
            return cb(null, { VpnGateways: [{ VpnGatewayId: 'gw-abcdef' }] });
        });
        // WHEN
        const result = await provider.getValue({ filter });
        // THEN
        test.deepEqual(result, {
            vpcId: 'vpc-1234567',
            availabilityZones: ['bermuda-triangle-1337'],
            isolatedSubnetIds: undefined,
            isolatedSubnetNames: undefined,
            isolatedSubnetRouteTableIds: undefined,
            privateSubnetIds: ['sub-789012'],
            privateSubnetNames: ['Private'],
            privateSubnetRouteTableIds: ['rtb-789012'],
            publicSubnetIds: ['sub-123456'],
            publicSubnetNames: ['Public'],
            publicSubnetRouteTableIds: ['rtb-123456'],
            vpnGatewayId: 'gw-abcdef'
        });
        test.done();
        AWS.restore();
    },
    async 'throws when no such VPC is found'(test) {
        // GIVEN
        const filter = { foo: 'bar' };
        const provider = new vpcs_1.VpcNetworkContextProviderPlugin(mockSDK);
        AWS.mock('EC2', 'describeVpcs', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'foo', Values: ['bar'] }]);
            return cb(null, {});
        });
        // WHEN
        try {
            await provider.getValue({ filter });
            throw Error('The expected exception was not raised!');
        }
        catch (e) {
            test.throws(() => { throw e; }, /Could not find any VPCs matching/);
        }
        test.done();
        AWS.restore();
    },
    async 'throws when multiple VPCs are found'(test) {
        // GIVEN
        const filter = { foo: 'bar' };
        const provider = new vpcs_1.VpcNetworkContextProviderPlugin(mockSDK);
        AWS.mock('EC2', 'describeVpcs', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'foo', Values: ['bar'] }]);
            return cb(null, { Vpcs: [{ VpcId: 'vpc-1' }, { VpcId: 'vpc-2' }] });
        });
        // WHEN
        try {
            await provider.getValue({ filter });
            throw Error('The expected exception was not raised!');
        }
        catch (e) {
            test.throws(() => { throw e; }, /Found 2 VPCs matching/);
        }
        test.done();
        AWS.restore();
    },
    async 'uses the VPC main route table when a subnet has no specific association'(test) {
        // GIVEN
        const filter = { foo: 'bar' };
        const provider = new vpcs_1.VpcNetworkContextProviderPlugin(mockSDK);
        AWS.mock('EC2', 'describeVpcs', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'foo', Values: ['bar'] }]);
            return cb(null, { Vpcs: [{ VpcId: 'vpc-1234567' }] });
        });
        AWS.mock('EC2', 'describeSubnets', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'vpc-id', Values: ['vpc-1234567'] }]);
            return cb(null, {
                Subnets: [
                    { SubnetId: 'sub-123456', AvailabilityZone: 'bermuda-triangle-1337', MapPublicIpOnLaunch: true },
                    { SubnetId: 'sub-789012', AvailabilityZone: 'bermuda-triangle-1337', MapPublicIpOnLaunch: false }
                ]
            });
        });
        AWS.mock('EC2', 'describeRouteTables', (params, cb) => {
            test.deepEqual(params.Filters, [{ Name: 'vpc-id', Values: ['vpc-1234567'] }]);
            return cb(null, {
                RouteTables: [
                    { Associations: [{ SubnetId: 'sub-123456' }], RouteTableId: 'rtb-123456', },
                    { Associations: [{ Main: true }], RouteTableId: 'rtb-789012', }
                ]
            });
        });
        AWS.mock('EC2', 'describeVpnGateways', (params, cb) => {
            test.deepEqual(params.Filters, [
                { Name: 'attachment.vpc-id', Values: ['vpc-1234567'] },
                { Name: 'attachment.state', Values: ['attached'] },
                { Name: 'state', Values: ['available'] }
            ]);
            return cb(null, { VpnGateways: [{ VpnGatewayId: 'gw-abcdef' }] });
        });
        // WHEN
        const result = await provider.getValue({ filter });
        // THEN
        test.deepEqual(result, {
            vpcId: 'vpc-1234567',
            availabilityZones: ['bermuda-triangle-1337'],
            isolatedSubnetIds: undefined,
            isolatedSubnetNames: undefined,
            isolatedSubnetRouteTableIds: undefined,
            privateSubnetIds: ['sub-789012'],
            privateSubnetNames: ['Private'],
            privateSubnetRouteTableIds: ['rtb-789012'],
            publicSubnetIds: ['sub-123456'],
            publicSubnetNames: ['Public'],
            publicSubnetRouteTableIds: ['rtb-123456'],
            vpnGatewayId: 'gw-abcdef'
        });
        test.done();
        AWS.restore();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC52cGNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC52cGNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwrQkFBZ0M7QUFDaEMsb0NBQXFDO0FBQ3JDLHFDQUFzQztBQUV0QywyREFBbUY7QUFFbkYsR0FBRyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUV4QixNQUFNLE9BQU8sR0FBUztJQUNwQixjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7SUFDckQsYUFBYSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUM7SUFDN0QsY0FBYyxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hELEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3pDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakQsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztDQUM5QyxDQUFDO0FBSUYsaUJBQVMsUUFBUSxDQUFDLFFBQVEsQ0FBQztJQUN6QixLQUFLLENBQUMsNEJBQTRCLENBQUMsSUFBbUI7UUFDcEQsUUFBUTtRQUNSLE1BQU0sTUFB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QU0sRUFBRSxDQUFFLFVBQVUsQ0FBRSxFQUFFO2dCQUNwRCxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUUsV0FBVyxDQUFFLEVBQUU7YUFDM0MsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDcEUsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUVuRCxPQUFPO1FBQ1AsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDckIsS0FBSyxFQUFFLGFBQWE7WUFDcEIsaUJBQWlCLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQztZQUM1QyxpQkFBaUIsRUFBRSxTQUFTO1lBQzVCLG1CQUFtQixFQUFFLFNBQVM7WUFDOUIsMkJBQTJCLEVBQUUsU0FBUztZQUN0QyxnQkFBZ0IsRUFBRSxDQUFDLFlBQVksQ0FBQztZQUNoQyxrQkFBa0IsRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUMvQiwwQkFBMEIsRUFBRSxDQUFDLFlBQVksQ0FBQztZQUMxQyxlQUFlLEVBQUUsQ0FBQyxZQUFZLENBQUM7WUFDL0IsaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLENBQUM7WUFDN0IseUJBQXlCLEVBQUUsQ0FBQyxZQUFZLENBQUM7WUFDekMsWUFBWSxFQUFFLFdBQVc7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2hCLENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXdzID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuaW1wb3J0IEFXUyA9IHJlcXVpcmUoJ2F3cy1zZGstbW9jaycpO1xuaW1wb3J0IG5vZGV1bml0ID0gcmVxdWlyZSgnbm9kZXVuaXQnKTtcbmltcG9ydCB7IElTREsgfSBmcm9tICcuLi8uLi9saWIvYXBpJztcbmltcG9ydCB7IFZwY05ldHdvcmtDb250ZXh0UHJvdmlkZXJQbHVnaW4gfSBmcm9tICcuLi8uLi9saWIvY29udGV4dC1wcm92aWRlcnMvdnBjcyc7XG5cbkFXUy5zZXRTREtJbnN0YW5jZShhd3MpO1xuXG5jb25zdCBtb2NrU0RLOiBJU0RLID0ge1xuICBkZWZhdWx0QWNjb3VudDogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCcxMjM0NTY3ODkwMTInKSxcbiAgZGVmYXVsdFJlZ2lvbjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCdiZXJtdWRhLXRyaWFuZ2xlLTEzMzcnKSxcbiAgY2xvdWRGb3JtYXRpb246ICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdOb3QgTW9ja2VkJyk7IH0sXG4gIGVjMjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKG5ldyBhd3MuRUMyKCkpLFxuICBlY3I6ICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdOb3QgTW9ja2VkJyk7IH0sXG4gIHJvdXRlNTM6ICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdOb3QgTW9ja2VkJyk7IH0sXG4gIHMzOiAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignTm90IE1vY2tlZCcpOyB9LFxuICBzc206ICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdOb3QgTW9ja2VkJyk7IH0sXG59O1xuXG50eXBlIEF3c0NhbGxiYWNrPFQ+ID0gKGVycjogRXJyb3IgfCBudWxsLCB2YWw6IFQpID0+IHZvaWQ7XG5cbmV4cG9ydCA9IG5vZGV1bml0LnRlc3RDYXNlKHtcbiAgYXN5bmMgJ2xvb2tzIHVwIHRoZSByZXF1ZXN0ZWQgVlBDJyh0ZXN0OiBub2RldW5pdC5UZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBmaWx0ZXIgPSB7IGZvbzogJ2JhcicgfTtcbiAgICBjb25zdCBwcm92aWRlciA9IG5ldyBWcGNOZXR3b3JrQ29udGV4dFByb3ZpZGVyUGx1Z2luKG1vY2tTREspO1xuXG4gICAgQVdTLm1vY2soJ0VDMicsICdkZXNjcmliZVZwY3MnLCAocGFyYW1zOiBhd3MuRUMyLkRlc2NyaWJlVnBjc1JlcXVlc3QsIGNiOiBBd3NDYWxsYmFjazxhd3MuRUMyLkRlc2NyaWJlVnBjc1Jlc3VsdD4pID0+IHtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcy5GaWx0ZXJzLCBbeyBOYW1lOiAnZm9vJywgVmFsdWVzOiBbJ2JhciddIH1dKTtcbiAgICAgIHJldHVybiBjYihudWxsLCB7IFZwY3M6IFt7IFZwY0lkOiAndnBjLTEyMzQ1NjcnIH1dIH0pO1xuICAgIH0pO1xuICAgIEFXUy5tb2NrKCdFQzInLCAnZGVzY3JpYmVTdWJuZXRzJywgKHBhcmFtczogYXdzLkVDMi5EZXNjcmliZVN1Ym5ldHNSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8YXdzLkVDMi5EZXNjcmliZVN1Ym5ldHNSZXN1bHQ+KSA9PiB7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChwYXJhbXMuRmlsdGVycywgW3sgTmFtZTogJ3ZwYy1pZCcsIFZhbHVlczogWyd2cGMtMTIzNDU2NyddIH1dKTtcbiAgICAgIHJldHVybiBjYihudWxsLCB7XG4gICAgICAgIFN1Ym5ldHM6IFtcbiAgICAgICAgICB7IFN1Ym5ldElkOiAnc3ViLTEyMzQ1NicsIEF2YWlsYWJpbGl0eVpvbmU6ICdiZXJtdWRhLXRyaWFuZ2xlLTEzMzcnLCBNYXBQdWJsaWNJcE9uTGF1bmNoOiB0cnVlIH0sXG4gICAgICAgICAgeyBTdWJuZXRJZDogJ3N1Yi03ODkwMTInLCBBdmFpbGFiaWxpdHlab25lOiAnYmVybXVkYS10cmlhbmdsZS0xMzM3JywgTWFwUHVibGljSXBPbkxhdW5jaDogZmFsc2UgfVxuICAgICAgICBdXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBBV1MubW9jaygnRUMyJywgJ2Rlc2NyaWJlUm91dGVUYWJsZXMnLCAocGFyYW1zOiBhd3MuRUMyLkRlc2NyaWJlUm91dGVUYWJsZXNSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8YXdzLkVDMi5EZXNjcmliZVJvdXRlVGFibGVzUmVzdWx0PikgPT4ge1xuICAgICAgdGVzdC5kZWVwRXF1YWwocGFyYW1zLkZpbHRlcnMsIFt7IE5hbWU6ICd2cGMtaWQnLCBWYWx1ZXM6IFsndnBjLTEyMzQ1NjcnXSB9XSk7XG4gICAgICByZXR1cm4gY2IobnVsbCwge1xuICAgICAgICBSb3V0ZVRhYmxlczogW1xuICAgICAgICAgIHsgQXNzb2NpYXRpb25zOiBbeyBTdWJuZXRJZDogJ3N1Yi0xMjM0NTYnIH1dLCBSb3V0ZVRhYmxlSWQ6ICdydGItMTIzNDU2JywgfSxcbiAgICAgICAgICB7IEFzc29jaWF0aW9uczogW3sgU3VibmV0SWQ6ICdzdWItNzg5MDEyJyB9XSwgUm91dGVUYWJsZUlkOiAncnRiLTc4OTAxMicsIH1cbiAgICAgICAgXVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgQVdTLm1vY2soJ0VDMicsICdkZXNjcmliZVZwbkdhdGV3YXlzJywgKHBhcmFtczogYXdzLkVDMi5EZXNjcmliZVZwbkdhdGV3YXlzUmVxdWVzdCwgY2I6IEF3c0NhbGxiYWNrPGF3cy5FQzIuRGVzY3JpYmVWcG5HYXRld2F5c1Jlc3VsdD4pID0+IHtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcy5GaWx0ZXJzLCBbXG4gICAgICAgIHsgTmFtZTogJ2F0dGFjaG1lbnQudnBjLWlkJywgVmFsdWVzOiBbICd2cGMtMTIzNDU2NycgXSB9LFxuICAgICAgICB7IE5hbWU6ICdhdHRhY2htZW50LnN0YXRlJywgVmFsdWVzOiBbICdhdHRhY2hlZCcgXSB9LFxuICAgICAgICB7IE5hbWU6ICdzdGF0ZScsIFZhbHVlczogWyAnYXZhaWxhYmxlJyBdIH1cbiAgICAgIF0pO1xuICAgICAgcmV0dXJuIGNiKG51bGwsIHsgVnBuR2F0ZXdheXM6IFt7IFZwbkdhdGV3YXlJZDogJ2d3LWFiY2RlZicgfV0gfSk7XG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvdmlkZXIuZ2V0VmFsdWUoeyBmaWx0ZXIgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5kZWVwRXF1YWwocmVzdWx0LCB7XG4gICAgICB2cGNJZDogJ3ZwYy0xMjM0NTY3JyxcbiAgICAgIGF2YWlsYWJpbGl0eVpvbmVzOiBbJ2Jlcm11ZGEtdHJpYW5nbGUtMTMzNyddLFxuICAgICAgaXNvbGF0ZWRTdWJuZXRJZHM6IHVuZGVmaW5lZCxcbiAgICAgIGlzb2xhdGVkU3VibmV0TmFtZXM6IHVuZGVmaW5lZCxcbiAgICAgIGlzb2xhdGVkU3VibmV0Um91dGVUYWJsZUlkczogdW5kZWZpbmVkLFxuICAgICAgcHJpdmF0ZVN1Ym5ldElkczogWydzdWItNzg5MDEyJ10sXG4gICAgICBwcml2YXRlU3VibmV0TmFtZXM6IFsnUHJpdmF0ZSddLFxuICAgICAgcHJpdmF0ZVN1Ym5ldFJvdXRlVGFibGVJZHM6IFsncnRiLTc4OTAxMiddLFxuICAgICAgcHVibGljU3VibmV0SWRzOiBbJ3N1Yi0xMjM0NTYnXSxcbiAgICAgIHB1YmxpY1N1Ym5ldE5hbWVzOiBbJ1B1YmxpYyddLFxuICAgICAgcHVibGljU3VibmV0Um91dGVUYWJsZUlkczogWydydGItMTIzNDU2J10sXG4gICAgICB2cG5HYXRld2F5SWQ6ICdndy1hYmNkZWYnXG4gICAgfSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgICBBV1MucmVzdG9yZSgpO1xuICB9LFxuXG4gIGFzeW5jICd0aHJvd3Mgd2hlbiBubyBzdWNoIFZQQyBpcyBmb3VuZCcodGVzdDogbm9kZXVuaXQuVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgZmlsdGVyID0geyBmb286ICdiYXInIH07XG4gICAgY29uc3QgcHJvdmlkZXIgPSBuZXcgVnBjTmV0d29ya0NvbnRleHRQcm92aWRlclBsdWdpbihtb2NrU0RLKTtcblxuICAgIEFXUy5tb2NrKCdFQzInLCAnZGVzY3JpYmVWcGNzJywgKHBhcmFtczogYXdzLkVDMi5EZXNjcmliZVZwY3NSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8YXdzLkVDMi5EZXNjcmliZVZwY3NSZXN1bHQ+KSA9PiB7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChwYXJhbXMuRmlsdGVycywgW3sgTmFtZTogJ2ZvbycsIFZhbHVlczogWydiYXInXSB9XSk7XG4gICAgICByZXR1cm4gY2IobnVsbCwge30pO1xuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwcm92aWRlci5nZXRWYWx1ZSh7IGZpbHRlciB9KTtcbiAgICAgIHRocm93IEVycm9yKCdUaGUgZXhwZWN0ZWQgZXhjZXB0aW9uIHdhcyBub3QgcmFpc2VkIScpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRlc3QudGhyb3dzKCgpID0+IHsgdGhyb3cgZTsgfSwgL0NvdWxkIG5vdCBmaW5kIGFueSBWUENzIG1hdGNoaW5nLyk7XG4gICAgfVxuXG4gICAgdGVzdC5kb25lKCk7XG4gICAgQVdTLnJlc3RvcmUoKTtcbiAgfSxcblxuICBhc3luYyAndGhyb3dzIHdoZW4gbXVsdGlwbGUgVlBDcyBhcmUgZm91bmQnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGZpbHRlciA9IHsgZm9vOiAnYmFyJyB9O1xuICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IFZwY05ldHdvcmtDb250ZXh0UHJvdmlkZXJQbHVnaW4obW9ja1NESyk7XG5cbiAgICBBV1MubW9jaygnRUMyJywgJ2Rlc2NyaWJlVnBjcycsIChwYXJhbXM6IGF3cy5FQzIuRGVzY3JpYmVWcGNzUmVxdWVzdCwgY2I6IEF3c0NhbGxiYWNrPGF3cy5FQzIuRGVzY3JpYmVWcGNzUmVzdWx0PikgPT4ge1xuICAgICAgdGVzdC5kZWVwRXF1YWwocGFyYW1zLkZpbHRlcnMsIFt7IE5hbWU6ICdmb28nLCBWYWx1ZXM6IFsnYmFyJ10gfV0pO1xuICAgICAgcmV0dXJuIGNiKG51bGwsIHsgVnBjczogW3sgVnBjSWQ6ICd2cGMtMScgfSwgeyBWcGNJZDogJ3ZwYy0yJyB9XX0pO1xuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwcm92aWRlci5nZXRWYWx1ZSh7IGZpbHRlciB9KTtcbiAgICAgIHRocm93IEVycm9yKCdUaGUgZXhwZWN0ZWQgZXhjZXB0aW9uIHdhcyBub3QgcmFpc2VkIScpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRlc3QudGhyb3dzKCgpID0+IHsgdGhyb3cgZTsgfSwgL0ZvdW5kIDIgVlBDcyBtYXRjaGluZy8pO1xuICAgIH1cblxuICAgIHRlc3QuZG9uZSgpO1xuICAgIEFXUy5yZXN0b3JlKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ3VzZXMgdGhlIFZQQyBtYWluIHJvdXRlIHRhYmxlIHdoZW4gYSBzdWJuZXQgaGFzIG5vIHNwZWNpZmljIGFzc29jaWF0aW9uJyh0ZXN0OiBub2RldW5pdC5UZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBmaWx0ZXIgPSB7IGZvbzogJ2JhcicgfTtcbiAgICBjb25zdCBwcm92aWRlciA9IG5ldyBWcGNOZXR3b3JrQ29udGV4dFByb3ZpZGVyUGx1Z2luKG1vY2tTREspO1xuXG4gICAgQVdTLm1vY2soJ0VDMicsICdkZXNjcmliZVZwY3MnLCAocGFyYW1zOiBhd3MuRUMyLkRlc2NyaWJlVnBjc1JlcXVlc3QsIGNiOiBBd3NDYWxsYmFjazxhd3MuRUMyLkRlc2NyaWJlVnBjc1Jlc3VsdD4pID0+IHtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcy5GaWx0ZXJzLCBbeyBOYW1lOiAnZm9vJywgVmFsdWVzOiBbJ2JhciddIH1dKTtcbiAgICAgIHJldHVybiBjYihudWxsLCB7IFZwY3M6IFt7IFZwY0lkOiAndnBjLTEyMzQ1NjcnIH1dIH0pO1xuICAgIH0pO1xuICAgIEFXUy5tb2NrKCdFQzInLCAnZGVzY3JpYmVTdWJuZXRzJywgKHBhcmFtczogYXdzLkVDMi5EZXNjcmliZVN1Ym5ldHNSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8YXdzLkVDMi5EZXNjcmliZVN1Ym5ldHNSZXN1bHQ+KSA9PiB7XG4gICAgICB0ZXN0LmRlZXBFcXVhbChwYXJhbXMuRmlsdGVycywgW3sgTmFtZTogJ3ZwYy1pZCcsIFZhbHVlczogWyd2cGMtMTIzNDU2NyddIH1dKTtcbiAgICAgIHJldHVybiBjYihudWxsLCB7XG4gICAgICAgIFN1Ym5ldHM6IFtcbiAgICAgICAgICB7IFN1Ym5ldElkOiAnc3ViLTEyMzQ1NicsIEF2YWlsYWJpbGl0eVpvbmU6ICdiZXJtdWRhLXRyaWFuZ2xlLTEzMzcnLCBNYXBQdWJsaWNJcE9uTGF1bmNoOiB0cnVlIH0sXG4gICAgICAgICAgeyBTdWJuZXRJZDogJ3N1Yi03ODkwMTInLCBBdmFpbGFiaWxpdHlab25lOiAnYmVybXVkYS10cmlhbmdsZS0xMzM3JywgTWFwUHVibGljSXBPbkxhdW5jaDogZmFsc2UgfVxuICAgICAgICBdXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBBV1MubW9jaygnRUMyJywgJ2Rlc2NyaWJlUm91dGVUYWJsZXMnLCAocGFyYW1zOiBhd3MuRUMyLkRlc2NyaWJlUm91dGVUYWJsZXNSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8YXdzLkVDMi5EZXNjcmliZVJvdXRlVGFibGVzUmVzdWx0PikgPT4ge1xuICAgICAgdGVzdC5kZWVwRXF1YWwocGFyYW1zLkZpbHRlcnMsIFt7IE5hbWU6ICd2cGMtaWQnLCBWYWx1ZXM6IFsndnBjLTEyMzQ1NjcnXSB9XSk7XG4gICAgICByZXR1cm4gY2IobnVsbCwge1xuICAgICAgICBSb3V0ZVRhYmxlczogW1xuICAgICAgICAgIHsgQXNzb2NpYXRpb25zOiBbeyBTdWJuZXRJZDogJ3N1Yi0xMjM0NTYnIH1dLCBSb3V0ZVRhYmxlSWQ6ICdydGItMTIzNDU2JywgfSxcbiAgICAgICAgICB7IEFzc29jaWF0aW9uczogW3sgTWFpbjogdHJ1ZSB9XSwgUm91dGVUYWJsZUlkOiAncnRiLTc4OTAxMicsIH1cbiAgICAgICAgXVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgQVdTLm1vY2soJ0VDMicsICdkZXNjcmliZVZwbkdhdGV3YXlzJywgKHBhcmFtczogYXdzLkVDMi5EZXNjcmliZVZwbkdhdGV3YXlzUmVxdWVzdCwgY2I6IEF3c0NhbGxiYWNrPGF3cy5FQzIuRGVzY3JpYmVWcG5HYXRld2F5c1Jlc3VsdD4pID0+IHtcbiAgICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcy5GaWx0ZXJzLCBbXG4gICAgICAgIHsgTmFtZTogJ2F0dGFjaG1lbnQudnBjLWlkJywgVmFsdWVzOiBbICd2cGMtMTIzNDU2NycgXSB9LFxuICAgICAgICB7IE5hbWU6ICdhdHRhY2htZW50LnN0YXRlJywgVmFsdWVzOiBbICdhdHRhY2hlZCcgXSB9LFxuICAgICAgICB7IE5hbWU6ICdzdGF0ZScsIFZhbHVlczogWyAnYXZhaWxhYmxlJyBdIH1cbiAgICAgIF0pO1xuICAgICAgcmV0dXJuIGNiKG51bGwsIHsgVnBuR2F0ZXdheXM6IFt7IFZwbkdhdGV3YXlJZDogJ2d3LWFiY2RlZicgfV0gfSk7XG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJvdmlkZXIuZ2V0VmFsdWUoeyBmaWx0ZXIgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5kZWVwRXF1YWwocmVzdWx0LCB7XG4gICAgICB2cGNJZDogJ3ZwYy0xMjM0NTY3JyxcbiAgICAgIGF2YWlsYWJpbGl0eVpvbmVzOiBbJ2Jlcm11ZGEtdHJpYW5nbGUtMTMzNyddLFxuICAgICAgaXNvbGF0ZWRTdWJuZXRJZHM6IHVuZGVmaW5lZCxcbiAgICAgIGlzb2xhdGVkU3VibmV0TmFtZXM6IHVuZGVmaW5lZCxcbiAgICAgIGlzb2xhdGVkU3VibmV0Um91dGVUYWJsZUlkczogdW5kZWZpbmVkLFxuICAgICAgcHJpdmF0ZVN1Ym5ldElkczogWydzdWItNzg5MDEyJ10sXG4gICAgICBwcml2YXRlU3VibmV0TmFtZXM6IFsnUHJpdmF0ZSddLFxuICAgICAgcHJpdmF0ZVN1Ym5ldFJvdXRlVGFibGVJZHM6IFsncnRiLTc4OTAxMiddLFxuICAgICAgcHVibGljU3VibmV0SWRzOiBbJ3N1Yi0xMjM0NTYnXSxcbiAgICAgIHB1YmxpY1N1Ym5ldE5hbWVzOiBbJ1B1YmxpYyddLFxuICAgICAgcHVibGljU3VibmV0Um91dGVUYWJsZUlkczogWydydGItMTIzNDU2J10sXG4gICAgICB2cG5HYXRld2F5SWQ6ICdndy1hYmNkZWYnXG4gICAgfSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgICBBV1MucmVzdG9yZSgpO1xuICB9XG59KTtcbiJdfQ==